var o=class{#n;#e;#i;#t;#r;constructor(e,t,n){this.#n=e,this.#i=t,this.#r=n,this.#e=[]}get type(){return this.#n}get raw(){return this.#r??""}get parent(){return this.#i}get children(){return this.#e}get attributes(){if(this.#t)return this.#t;if(this.#t={},this.raw){let e=/([\w:.-]+)\s*=\s*["'](.*?)["']/g,t;for(;(t=e.exec(this.raw))!==null;)this.#t[t[1]]=t[2]}return this.#t}get innerText(){if(this.children.length){let e="";for(let t of this.children)e+=t.innerText;return e}return(this.raw.match(/<!\[CDATA\[(.*?)]]>/s)??[,this.raw])[1]}addChild(e){this.#e.push(e)}is(...e){if(!e.length)return!1;let t;for(let n of e.toReversed())if(t=t?t.parent:this,t?.type!==n)return!1;return!0}first(e){return this.children.find(t=>t.type===e)}all(...e){let t=this.children,n=[];for(let[h,d]of Object.entries(e)){if(Number.parseInt(h)===e.length-1){n=t.filter(i=>i.type===d);break}if(t=t?.find(i=>i.type===d)?.children,!t)return[]}return n}};var u={cdata:{end:"]]>",start:/^<!\[CDATA\[/},comment:{end:"-->",start:/^<!--/},declaration:{end:"?>",start:/^<\?/},doctype:{end:">",start:/^<!DOCTYPE/i},element:{end:">",start:/^<[\w:.-/]/}},m={buf:"",state:"skip",previous:["skip",-1],decoder:new TextDecoder,flush(r){this.buf.length>0&&r.enqueue(["text",this.buf])},transform(r,e){for(this.buf+=this.decoder.decode(r);this.buf.length&&!(this.state===this.previous[0]&&this.buf.length===this.previous[1]);){if(this.previous=[this.state,this.buf.length],this.state==="skip"){let t=this.buf.indexOf("<");if(t<0)break;e.enqueue(["text",this.buf.substring(0,t)]),this.buf=this.buf.substring(t),this.state="search"}if(this.state==="search"){if(this.buf.length<3)break;for(let[t,n]of Object.entries(u))if(this.buf.match(n.start)){this.state=t;break}continue}if(Object.hasOwn(u,this.state)){let{end:t}=u[this.state],n=this.buf.indexOf(t);if(n<0)break;e.enqueue([this.state,this.buf.substring(0,n+t.length)]),this.buf=this.buf.substring(n+t.length),this.state="skip";continue}throw new Error}}},c=class extends TransformStream{constructor(){super({...m})}};var p={comment:"ignoreComments",declaration:"ignoreDeclaration",doctype:"ignoreDoctype"};async function*A(r,e){r=new URL(r);let t=new o("@document");try{let n={...e?.fetchOptions};e?.signal&&(n.signal=e.signal);let h=await fetch(r,n);if(!h.ok||!h.body)throw new Error("Bad response");let d=h.body.pipeThrough(new c,{signal:e?.signal}),i=t;for await(let[a,s]of d){if(e?.signal?.aborted)break;if(!(a==="text"&&e?.ignoreWhitespace!==!1&&s.trim().length===0)){if(a in p&&e?.[p[a]]===!1){let f=new o(a,i,s);i.addChild(f),yield f;continue}if(a==="element"){let f=s.match(/<\/?([\w:.]+)/)[1];if(s.endsWith("/>")){let g=new o(f,i,s);i.addChild(g),yield g;continue}if(s.startsWith("</")){yield i,i=i.parent;continue}let l=new o(f,i,s);i.addChild(l),i=l;continue}i.addChild(new o(a,i,s))}}}catch(n){if(e?.silent===!1)throw n}return t}export{o as Node,c as XMLStream,A as parse,m as transformer};
